apiVersion: v1
kind: Template
metadata:
  creationTimestamp: null
  name: sonarqube
objects:
- apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: openshift-sonarqube
  spec:
    accessModes:
      - ReadWriteMany
    resources:
      requests:
        storage: ${VOLUME_CAPACITY}
- apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    name: postgresql
  spec:
    accessModes:
      - ReadWriteMany
    resources:
      requests:
        storage: ${SONAR_DB_VOLUME_CAPACITY}
- apiVersion: v1
  kind: Secret
  metadata:
    name: postgresql
  stringData:
    database-user: ${POSTGRESQL_USER}
    database-password: ${POSTGRESQL_PASSWORD}
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    creationTimestamp: null
    generation: 2
    labels:
      app: postgresql-persistent
      appName: sonarqube
      template: postgresql-persistent-template
      name: postgresql
    name: postgresql
  spec:
    replicas: 1
    selector:
      name: postgresql
    strategy:
      activeDeadlineSeconds: 21600
      recreateParams:
        timeoutSeconds: 600
      resources: {}
      type: Recreate
    template:
      metadata:
        creationTimestamp: null
        labels:
          name: postgresql
      spec:
        containers:
        - env:
          - name: POSTGRESQL_USER
            valueFrom:
              secretKeyRef:
                key: database-user
                name: postgresql
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                key: database-password
                name: postgresql
          - name: POSTGRESQL_DATABASE
            value: sonar
          image: 'centos/postgresql-95-centos7@sha256:90900f49fd0610bf9a2d6da02a1bd5773ea412ed4c56d49b390595838b5a1431'
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 5432
            timeoutSeconds: 1
          name: postgresql
          ports:
          - containerPort: 5432
            protocol: TCP
          readinessProbe:
            exec:
              command:
              - /bin/sh
              - -i
              - -c
              - psql -h 127.0.0.1 -U $POSTGRESQL_USER -q -d $POSTGRESQL_DATABASE -c
                'SELECT 1'
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              memory: ${SONAR_DB_MEMORY}
          securityContext:
            capabilities: {}
            privileged: false
          terminationMessagePath: /dev/termination-log
          volumeMounts:
          - mountPath: /var/lib/pgsql/data
            name: postgresql-data
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        securityContext: {}
        terminationGracePeriodSeconds: 30
        volumes:
        - name: postgresql-data
          persistentVolumeClaim:
            claimName: postgresql
    test: false
    triggers:
    - type: ImageChange
      imageChangeParams:
        automatic: true
        containerNames:
        - postgresql
        from:
          kind: ImageStreamTag
          name: 'postgresql:9.5'
          namespace: openshift
    - type: ConfigChange
- apiVersion: v1
  kind: Service
  metadata:
    creationTimestamp: null
    labels:
      app: postgresql-persistent
      appName: sonarqube
      template: postgresql-persistent-template
    name: postgresql
  spec:
    ports:
    - name: postgresql
      port: 5432
      protocol: TCP
      targetPort: 5432
    selector:
      name: postgresql
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: Route
  metadata:
    annotations:
      openshift.io/host.generated: "true"
    creationTimestamp: null
    labels:
      appName: sonarqube
    name: openshift-sonarqube
  spec:
    port:
      targetPort: 9000-tcp
    to:
      kind: Service
      name: openshift-sonarqube
      weight: 100
    wildcardPolicy: None
- apiVersion: v1
  kind: ImageStream
  metadata:
    annotations:
      openshift.io/generated-by: OpenShiftNewApp
    creationTimestamp: null
    generation: 1
    labels:
      app: openshift-sonarqube
      appName: sonarqube
    name: openshift-sonarqube
  spec:
    tags:
    - annotations: null
      from:
        kind: DockerImage
        name: 'openshift-sonarqube:latest'
      generation: null
      importPolicy: {}
      name: latest
      referencePolicy:
        type: ""
  status:
    dockerImageRepository: ""
- apiVersion: v1
  kind: ImageStream
  metadata:
    annotations:
    creationTimestamp: null
    generation: 2
    labels:
      app: sonarqube
      appName: sonarqube
    name: sonarqube
  spec:
    tags:
    - annotations:
        openshift.io/generated-by: OpenShiftWebConsole
        openshift.io/imported-from: 'sonarqube:latest'
      from:
        kind: DockerImage
        name: 'sonarqube:latest'
      generation: 2
      importPolicy: {}
      name: latest
      referencePolicy:
        type: Source
  status:
    dockerImageRepository: ""
- apiVersion: v1
  kind: Service
  metadata:
    creationTimestamp: null
    annotations:
      service.alpha.openshift.io/dependencies: '[{"name":"postgresql","namespace":"","kind":"Service"}]'
    labels:
      app: openshift-sonarqube
      appName: sonarqube
    name: openshift-sonarqube
  spec:
    ports:
    - name: 9000-tcp
      port: 9000
      protocol: TCP
      targetPort: 9000
    selector:
      app: openshift-sonarqube
      deploymentconfig: openshift-sonarqube
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: BuildConfig
  metadata:
    annotations:
      openshift.io/generated-by: OpenShiftNewApp
    creationTimestamp: null
    labels:
      app: openshift-sonarqube
      appName: sonarqube
    name: openshift-sonarqube
  spec:
    nodeSelector: null
    output:
      to:
        kind: ImageStreamTag
        name: 'openshift-sonarqube:latest'
    postCommit: {}
    resources: {}
    runPolicy: Serial
    source:
      git:
        uri: 'https://github.com/InfoSec812/openshift-sonarqube.git'
        ref: include-postgresql
      type: Git
    strategy:
      dockerStrategy:
        from:
          kind: ImageStreamTag
          name: 'sonarqube:latest'
        env:
          - name: SONAR_PLUGINS_LIST
            value: ${SONAR_PLUGINS_LIST}
      type: Docker
    triggers:
    - github:
        secret: tu5UyJNNhAyxXYrcnDTZ
      type: GitHub
    - generic:
        secret: xhUU0WVDG3eA2Yu89zGe
      type: Generic
    - type: ConfigChange
    - imageChange: {}
      type: ImageChange
  status:
    lastVersion: 0
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    labels:
      app: openshift-sonarqube
      appName: sonarqube
      name: openshift-sonarqube
    name: openshift-sonarqube
  spec:
    replicas: 1
    selector:
      app: openshift-sonarqube
      deploymentconfig: openshift-sonarqube
    strategy:
      activeDeadlineSeconds: 21600
      resources: {}
      rollingParams:
        intervalSeconds: 1
        maxSurge: 25%
        maxUnavailable: 25%
        timeoutSeconds: 600
        updatePeriodSeconds: 1
      type: Rolling
    template:
      metadata:
        labels:
          app: openshift-sonarqube
          deploymentconfig: openshift-sonarqube
      spec:
        containers:
        - env:
          - name: SONAR_PLUGIN_LIST
            value: ${SONAR_PLUGIN_LIST}
          - name: SONARQUBE_WEB_JVM_OPTS
            value: ${SONARQUBE_WEB_JVM_OPTS}
          - name: SONAR_JDBC_USERNAME
            value: ${POSTGRESQL_USER}
          - name: SONAR_JDBC_PASSWORD
            value: ${POSTGRESQL_PASSWORD}
          - name: SONARQUBE_JDBC_URL
            value: ${SONARQUBE_JDBC_URL}
          - name: SONARQUBE_LDAP_BINDDN
            value: ${SONARQUBE_LDAP_BINDDN}
          - name: SONARQUBE_LDAP_BINDPASSWD
            value: ${SONARQUBE_LDAP_BINDPASSWD}
          - name: SONARQUBE_LDAP_URL
            value: ${SONARQUBE_LDAP_URL}
          - name: SONARQUBE_LDAP_REALM
            value: ${SONARQUBE_LDAP_REALM}
          - name: SONARQUBE_LDAP_CONTEXTFACTORY
            value: ${SONARQUBE_LDAP_CONTEXTFACTORY}
          - name: SONARQUBE_LDAP_STARTTLS
            value: ${SONARQUBE_LDAP_STARTTLS}
          - name: SONARQUBE_LDAP_AUTHENTICATION
            value: ${SONARQUBE_LDAP_AUTHENTICATION}
          - name: SONARQUBE_LDAP_USER_BASEDN
            value: ${SONARQUBE_LDAP_USER_BASEDN}
          - name: SONARQUBE_LDAP_USER_REQUEST
            value: ${SONARQUBE_LDAP_USER_REQUEST}
          - name: SONARQUBE_LDAP_USER_REAL_NAME_ATTR
            value: ${SONARQUBE_LDAP_USER_REAL_NAME_ATTR}
          - name: SONARQUBE_LDAP_USER_EMAIL_ATTR
            value: ${SONARQUBE_LDAP_USER_EMAIL_ATTR}
          - name: SONARQUBE_LDAP_GROUP_BASEDN
            value: ${SONARQUBE_LDAP_GROUP_BASEDN}
          - name: SONARQUBE_LDAP_GROUP_REQUEST
            value: ${SONARQUBE_LDAP_GROUP_REQUEST}
          - name: SONARQUBE_LDAP_GROUP_ID_ATTR
            value: ${SONARQUBE_LDAP_GROUP_ID_ATTR}
          - name: SONARQUBE_BUILDBREAKER_MAX_ATTEMPTS
            value: ${SONARQUBE_BUILDBREAKER_MAX_ATTEMPTS}
          - name: SONARQUBE_BUILDBREAKER_INTERVAL
            value: ${SONARQUBE_BUILDBREAKER_INTERVAL}
          - name: SONARQUBE_BUILDBREAKER_THRESHOLD
            value: ${SONARQUBE_BUILDBREAKER_THRESHOLD}
          - name: SONAR_BUILDBREAKER_DISABLE
            value: ${SONAR_BUILDBREAKER_DISABLE}
          imagePullPolicy: Always
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: 9000
              scheme: HTTP
            initialDelaySeconds: 45
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 3
          name: openshift-sonarqube
          ports:
          - containerPort: 9000
            protocol: TCP
          resources:
            limits:
              cpu: "2"
              memory: 2Gi
            requests:
              cpu: 500m
              memory: 1Gi
          terminationMessagePath: /dev/termination-log
          volumeMounts:
          - mountPath: /opt/sonarqube/data
            name: openshift-sonarqube
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        securityContext: {}
        terminationGracePeriodSeconds: 30
        volumes:
        - name: openshift-sonarqube
          persistentVolumeClaim:
            claimName: openshift-sonarqube
    test: false
    triggers:
    - type: ConfigChange
    - type: ImageChange
      imageChangeParams:
        automatic: true
        containerNames:
        - openshift-sonarqube
        from:
          kind: ImageStreamTag
          name: 'openshift-sonarqube:latest'
  status:
    availableReplicas: 0
    latestVersion: 0
    observedGeneration: 0
    replicas: 0
    unavailableReplicas: 0
    updatedReplicas: 0
parameters:
- name: SONAR_DB_MEMORY
  description: "The amount of RAM to allocate for the PostgreSQL DB service"
  value: 512Mi
- name: SONAR_DB_VOLUME_CAPACITY
  description: "The size of the persistent volume to claim for the PostgreSQL DB"
  value: 2Gi
- name: SONAR_PLUGINS_LIST
  description: "Space separated list of plugins (See: https://docs.sonarqube.org/display/PLUG/Plugin+Version+Matrix)"
  value: findbugs pmd ldap buildbreaker github gitlab
- name: VOLUME_CAPACITY
  description: The size of the Persistent Volume Claim to provision for SonarQube
  value: 2Gi
- name: SONARQUBE_WEB_JVM_OPTS
  description: Extra startup properties for SonarQube (in the form of "-Dsonar.someProperty=someValue")
  value:
- name: SONARQUBE_WEB_JVM_OPTS
  description: Extra startup properties for SonarQube (in the form of "-Dsonar.someProperty=someValue")
  value:
- name: POSTGRESQL_USER
  description: Username used for SonarQube database authentication (leave blank to use ephemeral database)
  from: "user[A-Za-z0-9]{4}"
  generate: expression
- name: POSTGRESQL_PASSWORD
  description: Password used for SonarQube database authentication (leave blank to use ephemeral database)
  from: "[A-Za-z0-9]{36}"
  generate: expression
- name: SONARQUBE_JDBC_URL
  description: Password used for SonarQube database authentication (leave blank to use ephemeral database)
  value: "jdbc:postgresql://postgresql:5432/sonar"
- name: SONARQUBE_LDAP_BINDDN
  description: Bind DN for LDAP authentication (leave blank for local authentication)
  value:
- name: SONARQUBE_LDAP_BINDPASSWD
  description: Bind password for LDAP authentication (leave blank for local authentication)
  value:
- name: SONARQUBE_LDAP_URL
  description: LDAP URL for authentication (leave blank for local authentication)
  value:
- name: SONARQUBE_LDAP_REALM
  description: LDAP Realm
  value:
- name: SONARQUBE_LDAP_CONTEXTFACTORY
  description: JNDI ContextFactory class to be used
  value: com.sun.jndi.ldap.LdapCtxFactory
- name: SONARQUBE_LDAP_STARTTLS
  description: Enable StartTLS for the LDAP connection
  value: "false"
- name: SONARQUBE_LDAP_AUTHENTICATION
  description:  LDAP authentication method (simple | CRAM-MD5 | DIGEST-MD5 | GSSAPI)
  value: simple
- name: SONARQUBE_LDAP_USER_BASEDN
  description: LDAP BaseDN under which to search for user objects
  value:
- name: SONARQUBE_LDAP_USER_REQUEST
  description: LDAP filter to select user objects
  value: (&(objectClass=inetOrgPerson)(uid={login}))
- name: SONARQUBE_LDAP_USER_REAL_NAME_ATTR
  description: LDAP attribute which holds the user's full name
  value: cn
- name: SONARQUBE_LDAP_USER_EMAIL_ATTR
  description: LDAP attribute which holds the user's e-mail address
  value: mail
- name: SONARQUBE_LDAP_GROUP_BASEDN
  description: LDAP BaseDN under which to search for group objects
  value:
- name: SONARQUBE_LDAP_GROUP_REQUEST
  description: LDAP filter to select group objects
  value: (&(objectClass=groupOfUniqueNames)(uniqueMember={dn}))
- name: SONARQUBE_LDAP_GROUP_ID_ATTR
  description: LDAP attribute which holds the group's ID
  value: cn
- name: SONARQUBE_BUILDBREAKER_MAX_ATTEMPTS
  description: Build Break plugin - Max number of poll attempts
  value: "30"
- name: SONARQUBE_BUILDBREAKER_INTERVAL
  description: Build Breaker plugin - Interval to wait between poll requests
  value: "20000"
- name: SONARQUBE_BUILDBREAKER_THRESHOLD
  description: Build Breaker plugin - Threshold at which a build will instantly break
  value: "CRITICAL"
- name: SONAR_BUILDBREAKER_DISABLE
  description: Build Breaker plugin - Disable the build breaker plugin for all builds
  value: "true"
- name: GITHUB_SECRET
  description: Generated secret key for GitHub webhooks
  from: "[A-Za-z0-9]{36}"
  generate: expression
- name: GENERIC_SECRET
  description: Generated secret key for generic webhooks
  from: "[A-Za-z0-9]{36}"
  generate: expression
